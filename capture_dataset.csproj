using OpenCvSharp;

namespace DatasetCollector
{
    class Program
    {
        static void Main(string[] args)
        {
            // Caminhos no Drive E:
            string baseDir = @"E:\eFact\Fotos_Data_Set";
            string className = "produto_v01";
            string savePath = Path.Combine(baseDir, "data", "raw", className);
            Directory.CreateDirectory(savePath);

            int width = 480, height = 270;
            bool zoomAtivo = false;
            int count = 0;
            Mat? lastSavedFrame = null;

            // Inicializa CÃ¢mera
            using var cap = new VideoCapture(0, VideoCaptureAPIs.DSHOW);
            cap.FrameWidth = 1280;
            cap.FrameHeight = 720;

            if (!cap.IsOpened()) return;

            // Setup das Janelas
            Cv2.NamedWindow("1. AO VIVO (MIRA)", WindowFlags.Normal);
            Cv2.NamedWindow("2. ULTIMA FOTO (Z = ZOOM)", WindowFlags.Normal);
            Cv2.ResizeWindow("1. AO VIVO (MIRA)", width, height);
            Cv2.ResizeWindow("2. ULTIMA FOTO (Z = ZOOM)", width, height);

            Console.WriteLine($"[INFO] Salvando em: {savePath}");
            Console.WriteLine("ATALHOS: [S] Salvar | [Z] Zoom | [Q] Sair");

            using var frame = new Mat();
            while (true)
            {
                cap.Read(frame);
                if (frame.Empty()) break;

                // --- JANELA 1: AO VIVO COM MIRA ---
                using var liveView = new Mat();
                Cv2.Resize(frame, liveView, new Size(width, height));
                
                // Desenhar Mira
                int cx = width / 2; int cy = height / 2;
                Cv2.Line(liveView, new Point(cx - 15, cy), new Point(cx + 15, cy), Scalar.Green, 1);
                Cv2.Line(liveView, new Point(cx, cy - 15), new Point(cx, cy + 15), Scalar.Green, 1);
                Cv2.Rectangle(liveView, new Rect(cx - 120, cy - 120, 240, 240), Scalar.LightGray, 1);
                Cv2.PutText(liveView, $"FOTOS: {count}", new Point(10, 25), HersheyFonts.HersheySimplex, 0.6, Scalar.Yellow, 2);

                Cv2.ImShow("1. AO VIVO (MIRA)", liveView);

                // --- JANELA 2: ULTIMA FOTO / ZOOM ---
                if (lastSavedFrame != null)
                {
                    using var displayFrame = new Mat();
                    if (zoomAtivo)
                    {
                        // Zoom de 300x300 no centro
                        int ox = lastSavedFrame.Width / 2;
                        int oy = lastSavedFrame.Height / 2;
                        var roi = new Rect(ox - 150, oy - 150, 300, 300);
                        using var crop = new Mat(lastSavedFrame, roi);
                        Cv2.Resize(crop, displayFrame, new Size(width, height));
                    }
                    else
                    {
                        Cv2.Resize(lastSavedFrame, displayFrame, new Size(width, height));
                    }

                    Cv2.PutText(displayFrame, zoomAtivo ? "ZOOM ON" : "INTEIRA", new Point(10, 25), HersheyFonts.HersheySimplex, 0.6, Scalar.Lime, 2);
                    Cv2.ImShow("2. ULTIMA FOTO (Z = ZOOM)", displayFrame);
                }

                int key = Cv2.WaitKey(1);
                if (key == 'q' || key == 'Q') break;
                if (key == 'z' || key == 'Z') zoomAtivo = !zoomAtivo;
                if (key == 's' || key == 'S')
                {
                    string ts = DateTime.Now.ToString("HHmmss_fff");
                    string fileName = Path.Combine(savePath, $"{className}_{ts}.jpg");
                    if (frame.SaveImage(fileName))
                    {
                        count++;
                        lastSavedFrame?.Dispose();
                        lastSavedFrame = frame.Clone();
                        Console.WriteLine($">>> Foto {count} salva em C#!");
                    }
                }
            }
        }
    }
}